import sys
import os
import json
import logging
import uuid
import requests
import time
import re
from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QLabel, QLineEdit, QPushButton, QMessageBox, QTextEdit,
    QListWidget, QSplitter, QStatusBar, QTreeWidget, QTreeWidgetItem,
    QComboBox, QFrame, QMenuBar, QMenu, QSystemTrayIcon, QCheckBox,
    QInputDialog, QDialog, QDialogButtonBox, QFormLayout, QTabWidget,
    QFileDialog, QListWidgetItem, QLineEdit, QGroupBox, QScrollArea,
    QKeySequenceEdit, QToolButton, QSizePolicy, QGridLayout, QFontComboBox,
    QSlider
)
from PyQt6.QtCore import Qt, QTimer, QSize, QDateTime, QEvent
from PyQt6.QtGui import QAction, QIcon, QKeySequence, QTextCursor, QColor, QTextCharFormat, QFont, QPixmap
from worker_thread import WorkerThread
)
from worker_thread import WorkerThread

# Loglama sistemi
logging.basicConfig(
    filename='app.log',
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger('DeepSeekChat')

class LoginWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("üîê DeepSeek Chat - Giri≈ü")
        self.setFixedSize(450, 400)
        
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        layout = QVBoxLayout()
        central_widget.setLayout(layout)
        
        # Logo
        self.logo_label = QLabel()
        self.logo_label.setPixmap(QIcon("icons/logo.png").pixmap(128, 128))
        self.logo_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(self.logo_label)
        
        # Giri≈ü alanlarƒ±
        self.username_input = QLineEdit()
        self.username_input.setPlaceholderText("Email")
        self.username_input.returnPressed.connect(self.attempt_login)
        
        self.password_input = QLineEdit()
        self.password_input.setPlaceholderText("≈ûifre")
        self.password_input.setEchoMode(QLineEdit.EchoMode.Password)
        self.password_input.returnPressed.connect(self.attempt_login)
        
        # "Beni Hatƒ±rla" se√ßeneƒüi
        self.remember_check = QCheckBox("Beni hatƒ±rla")
        self.remember_check.setChecked(True)
        
        # Giri≈ü butonu
        self.login_button = QPushButton()
        self.login_button.setIcon(QIcon("icons/login.png"))
        self.login_button.setIconSize(QSize(64, 64))
        self.login_button.setText(" Giri≈ü Yap")
        self.login_button.clicked.connect(self.attempt_login)
        
        # Otomatik giri≈ü butonu
        self.skip_login_button = QPushButton("Ge√ßici Olarak Atla")
        self.skip_login_button.clicked.connect(self.skip_login)
        
        # Layout
        layout.addWidget(self.logo_label)
        layout.addWidget(QLabel("Kullanƒ±cƒ± Adƒ±:"))
        layout.addWidget(self.username_input)
        layout.addWidget(QLabel("≈ûifre:"))
        layout.addWidget(self.password_input)
        layout.addWidget(self.remember_check)
        layout.addWidget(self.login_button)
        layout.addWidget(self.skip_login_button)
    
    def attempt_login(self):
        try:
            if self.remember_check.isChecked():
                with open("user_prefs.json", "w") as f:
                    json.dump({
                        "username": self.username_input.text(),
                        "remember": True
                    }, f)
            self.open_main_app()
        except Exception as e:
            logger.error(f"Giri≈ü hatasƒ±: {str(e)}")
            QMessageBox.critical(self, "Hata", f"Giri≈ü sƒ±rasƒ±nda hata olu≈ütu: {str(e)}")

    def skip_login(self):
        try:
            self.open_main_app()
        except Exception as e:
            logger.error(f"Giri≈ü atlama hatasƒ±: {str(e)}")
            QMessageBox.critical(self, "Hata", f"Uygulama a√ßƒ±lƒ±rken hata olu≈ütu: {str(e)}")

    def open_main_app(self):
        self.main_app = MainApplication()
        self.main_app.show()
        self.close()

class ErrorDialog(QDialog):
    def __init__(self, error_msg, parent=None):
        super().__init__(parent)
        self.setWindowTitle("‚ö†Ô∏è Hata Raporu")
        self.setFixedSize(500, 400)
        
        layout = QVBoxLayout()
        
        # Hata mesajƒ±
        error_label = QLabel("A≈üaƒüƒ±daki hata olu≈ütu:")
        layout.addWidget(error_label)
        
        self.error_text = QTextEdit()
        self.error_text.setPlainText(error_msg)
        self.error_text.setReadOnly(True)
        layout.addWidget(self.error_text)
        
        # Log dosyasƒ± butonu
        log_btn = QPushButton("Log Dosyasƒ±nƒ± A√ß")
        log_btn.clicked.connect(self.open_log)
        layout.addWidget(log_btn)
        
        # Kapat butonu
        buttons = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok)
        buttons.accepted.connect(self.accept)
        layout.addWidget(buttons)
        
        self.setLayout(layout)
    
    def open_log(self):
        try:
            if os.path.exists("app.log"):
                os.startfile("app.log")
        except Exception as e:
            QMessageBox.warning(self, "Hata", f"Log dosyasƒ± a√ßƒ±lamadƒ±: {str(e)}")

class MainApplication(QMainWindow):
    VERSION = "1.0.1"
    
    def __init__(self):
        super().__init__()
        self.setWindowTitle(f"üí¨ DeepSeek Chat v{self.VERSION}")
        self.setGeometry(100, 100, 1200, 800)
        
        # Hata yakalama
        sys.excepthook = self.handle_exception
        
        # Sistem Tepsisine Ekle (b√ºy√ºk ikon)
        pixmap = QPixmap("logo.png")
        scaled = pixmap.scaled(64, 64, Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation)
        self.tray_icon = QSystemTrayIcon(QIcon(scaled), self)
        self.setup_tray_icon()
        
        # Ana widget
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        # Ana layout
        main_layout = QHBoxLayout(central_widget)
        main_layout.setSpacing(5)
        main_layout.setContentsMargins(5, 5, 5, 5)
        
        # 1. Sol Sidebar (250px geni≈ülik)
        self.setup_sidebar()
        main_layout.addWidget(self.sidebar)
        
        # 2. Saƒü Panel (Esnek)
        self.setup_right_panel()
        main_layout.addWidget(self.right_panel, 1)
        
        # Status bar
        self.setup_statusbar()
        
        # Men√º √ßubuƒüu
        self.setup_menu_bar()

        minimize_btn = QToolButton()
        minimize_btn.setIcon(QIcon("icons/minimize.png"))
        minimize_btn.clicked.connect(self.minimize_to_tray)
        minimize_btn.setToolTip("Tepsiye indir")
        title_widget = QWidget()
        title_layout = QHBoxLayout(title_widget)
        title_layout.addStretch()
        title_layout.addWidget(minimize_btn)
        self.menuBar().setCornerWidget(title_widget)
        
        # Kƒ±sayollar
        self.setup_shortcuts()
        
        # Tema
        self.apply_theme("dark")

        self.api_key = None
        self.api_base_url = "https://openrouter.ai/api/v1"
        self.load_api_key()

        self.model_mapping = {
            "deepseek-chat": "deepseek/deepseek-r1:free",
            "deepseek-coder": "deepseek/deepseek-r1:free",
            "deepseek-math": "deepseek/deepseek-r1:free"
        }

        # Yazƒ± tipi ayarlarƒ±
        self.font_family = "Arial"
        self.font_size = 16
        self.label_bold = True
        self.italic_subtitles = False

        # Ekli dosyalar
        self.attached_files = []

        self.project_context = {}
        
        # Uygulama durumunu y√ºkle
        self.load_app_state()
        self.apply_font_settings()
        
        # Aktif sohbet ID'si
        self.active_chat_id = None
        
    def setup_statusbar(self):
        """Status bar'ƒ± kur"""
        status_bar = self.statusBar()
        status_bar.showMessage("‚úÖ Baƒülantƒ± kuruldu")
        

    def handle_exception(self, exc_type, exc_value, exc_traceback):
        """√ñzel hata y√∂neticisi"""
        error_msg = f"{exc_type.__name__}: {exc_value}"
        logger.error("Unhandled exception", exc_info=(exc_type, exc_value, exc_traceback))
        
        # Hata diyaloƒüunu g√∂ster
        error_dialog = ErrorDialog(error_msg, self)
        error_dialog.exec()

    def setup_tray_icon(self):
        pixmap = QPixmap("icons/logo.png").scaled(
            64,
            64,
            Qt.AspectRatioMode.KeepAspectRatio,
            Qt.TransformationMode.SmoothTransformation,
        )
        self.tray_icon = QSystemTrayIcon(QIcon(pixmap), self)

        tray_menu = QMenu()
        show_action = tray_menu.addAction("G√∂ster")
        show_action.triggered.connect(self.show_and_activate)

        check_update_action = tray_menu.addAction("G√ºncellemeleri Kontrol Et")
        check_update_action.triggered.connect(self.check_for_updates)

        quit_action = tray_menu.addAction("√áƒ±kƒ±≈ü")
        quit_action.triggered.connect(self.quit_application)

        self.tray_icon.setContextMenu(tray_menu)
        self.tray_icon.show()

    def setup_sidebar(self):
        self.sidebar = QFrame()
        self.sidebar.setObjectName("sidebar")
        self.sidebar.setFixedWidth(250)
        sidebar_layout = QVBoxLayout(self.sidebar)
        sidebar_layout.setContentsMargins(5, 5, 5, 5)
        sidebar_layout.setSpacing(10)
        
        # Arama Kutusu
        self.search_box = QLineEdit()
        self.search_box.setPlaceholderText("üîç Sohbetlerde ara...")
        self.search_box.textChanged.connect(self.filter_chats)
        sidebar_layout.addWidget(self.search_box)
        
        # Yeni Sohbet Butonu - B√ºy√ºk ikon (48x48)
        self.new_chat_btn = QPushButton()
        self.new_chat_btn.setIcon(QIcon("icons/new_chat.png"))
        self.new_chat_btn.setIconSize(QSize(48, 48))
        self.new_chat_btn.setText(" Yeni Sohbet")
        self.new_chat_btn.clicked.connect(self.new_chat)
        sidebar_layout.addWidget(self.new_chat_btn)
        
        # Sohbet Listesi
        self.chat_list = QListWidget()
        self.chat_list.itemClicked.connect(self.load_chat)
        self.chat_list.itemDoubleClicked.connect(self.edit_chat_title)
        self.chat_list.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        self.chat_list.customContextMenuRequested.connect(self.show_chat_list_context_menu)
        
        # S√ºr√ºkle-bƒ±rak √∂zelliƒüi
        self.chat_list.setDragEnabled(True)
        self.chat_list.setAcceptDrops(True)
        self.chat_list.setDragDropMode(QListWidget.DragDropMode.InternalMove)
        self.chat_list.model().rowsMoved.connect(self.chat_order_changed)
        
        sidebar_layout.addWidget(self.chat_list, 1)
        
        # Yeni Proje Butonu - B√ºy√ºk ikon (48x48)
        self.new_project_btn = QPushButton()
        self.new_project_btn.setIcon(QIcon("icons/new_folder.png"))
        self.new_project_btn.setIconSize(QSize(48, 48))
        self.new_project_btn.setText(" Yeni Proje")
        self.new_project_btn.clicked.connect(self.new_project)
        sidebar_layout.addWidget(self.new_project_btn)
        
        # Proje Aƒüacƒ±
        self.projects_tree = QTreeWidget()
        self.projects_tree.setHeaderLabel("Projeler")
        self.projects_tree.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        self.projects_tree.customContextMenuRequested.connect(self.show_project_context_menu)
        self.projects_tree.itemClicked.connect(self.load_project_chat)
        self.projects_tree.itemDoubleClicked.connect(self.edit_project_title)
        self.projects_tree.setAcceptDrops(True)
        self.projects_tree.viewport().setAcceptDrops(True)
        self.projects_tree.dragEnterEvent = self.project_drag_enter
        self.projects_tree.dropEvent = self.project_drop_event
        self.projects_tree.currentItemChanged.connect(self.load_project_context)
        sidebar_layout.addWidget(self.projects_tree, 1)
        
        # Model Se√ßimi
        model_box = QGroupBox("ü§ñ Model")
        model_layout = QVBoxLayout(model_box)
        self.model_combo = QComboBox()
        self.model_combo.addItems(["deepseek-chat", "deepseek-coder", "deepseek-math"])
        self.model_combo.currentIndexChanged.connect(self.model_changed)
        model_layout.addWidget(self.model_combo)
        sidebar_layout.addWidget(model_box)

        sidebar_layout.addStretch()

    def setup_right_panel(self):
        self.right_panel = QSplitter(Qt.Orientation.Vertical)

        # Sekmeli alan
        self.context_tabs = QTabWidget()

        # Mesaj G√∂r√ºnt√ºleme
        chat_tab = QWidget()
        chat_layout = QVBoxLayout(chat_tab)
        self.chat_display = QTextEdit()
        self.chat_display.setReadOnly(True)
        self.chat_display.setHtml("<center><i>Merhaba, size nasƒ±l yardƒ±mcƒ± olabilirim?</i></center>")
        self.chat_display.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        self.chat_display.customContextMenuRequested.connect(self.show_chat_context_menu)
        chat_layout.addWidget(self.chat_display)
        self.context_tabs.addTab(chat_tab, "üí¨ Sohbet")

        # Proje Baƒülamƒ± Sekmesi
        project_tab = QWidget()
        project_layout = QVBoxLayout(project_tab)
        self.project_instructions = QTextEdit()
        self.project_instructions.setPlaceholderText("Proje talimatlarƒ±...")
        project_layout.addWidget(QLabel("üìù Talimatlar:"))
        project_layout.addWidget(self.project_instructions)
        self.project_files_list = QListWidget()
        project_layout.addWidget(QLabel("üìÅ Dosyalar:"))
        project_layout.addWidget(self.project_files_list)
        file_btn_layout = QHBoxLayout()
        self.add_project_file_btn = QPushButton("Dosya Ekle")
        self.add_project_file_btn.clicked.connect(self.add_project_file)
        self.remove_project_file_btn = QPushButton("Dosya Sil")
        self.remove_project_file_btn.clicked.connect(self.remove_project_file)
        file_btn_layout.addWidget(self.add_project_file_btn)
        file_btn_layout.addWidget(self.remove_project_file_btn)
        project_layout.addLayout(file_btn_layout)
        self.context_tabs.addTab(project_tab, "üìÇ Proje Baƒülamƒ±")

        self.right_panel.addWidget(self.context_tabs)

        # Mesaj G√∂nderme Paneli
        send_panel = QWidget()
        send_layout = QVBoxLayout(send_panel)
        
        # Mesaj Giri≈üi
        self.message_input = QTextEdit()
        self.message_input.setPlaceholderText("DeepSeek'e mesaj yazƒ±n...")
        self.message_input.setMinimumHeight(100)
        self.message_input.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        self.message_input.customContextMenuRequested.connect(self.show_text_context_menu)
        self.message_input.installEventFilter(self)
        self.message_input.setAcceptDrops(True)

        self.attachments_list = QListWidget()
        send_layout.insertWidget(0, self.attachments_list)
        
        # Butonlar i√ßin alt panel
        bottom_layout = QHBoxLayout()
        
        # √ñzel √ñzellikler (Derin D√º≈ü√ºnce ve Web'de Ara) - B√ºy√ºk ikonlar (48x48)
        features_layout = QHBoxLayout()
        
        self.deep_thought_btn = QPushButton()
        self.deep_thought_btn.setIcon(QIcon("icons/brain.png"))
        self.deep_thought_btn.setIconSize(QSize(48, 48))
        self.deep_thought_btn.setText(" Derin D√º≈ü√ºnce")
        self.deep_thought_btn.setToolTip("Derin D√º≈ü√ºnce")
        self.deep_thought_btn.setCheckable(True)
        features_layout.addWidget(self.deep_thought_btn)
        
        self.web_search_btn = QPushButton()
        self.web_search_btn.setIcon(QIcon("icons/search.png"))
        self.web_search_btn.setIconSize(QSize(48, 48))
        self.web_search_btn.setText(" Web'de Ara")
        self.web_search_btn.setToolTip("Web'de Ara")
        self.web_search_btn.setCheckable(True)
        features_layout.addWidget(self.web_search_btn)
        
        bottom_layout.addLayout(features_layout)
        bottom_layout.addStretch()
        
        # Dosya Ekle Butonu - Yeni ikon (48x48)
        self.attach_btn = QPushButton()
        self.attach_btn.setIcon(QIcon("icons/attach_file.png"))
        self.attach_btn.setIconSize(QSize(48, 48))
        self.attach_btn.setText(" Dosya Ekle")
        self.attach_btn.setToolTip("Dosya ekle")
        self.attach_btn.clicked.connect(self.attach_file)
        bottom_layout.addWidget(self.attach_btn)
        
        # G√∂nder Butonu - Yeni ikon (48x48)
        self.send_btn = QPushButton()
        self.send_btn.setIcon(QIcon("icons/send_message.png"))
        self.send_btn.setIconSize(QSize(48, 48))
        self.send_btn.setText(" G√∂nder")
        self.send_btn.setToolTip("Mesajƒ± g√∂nder")
        self.send_btn.clicked.connect(self.send_message)
        self.send_btn.setSizePolicy(QSizePolicy.Policy.Fixed, QSizePolicy.Policy.Fixed)
        bottom_layout.addWidget(self.send_btn)
        
        send_layout.addWidget(self.message_input)
        send_layout.addLayout(bottom_layout)

        self.right_panel.addWidget(send_panel)
        self.right_panel.setSizes([600, 200])

    def setup_menu_bar(self):
        menubar = self.menuBar()
        
        # Dosya Men√ºs√º
        file_menu = menubar.addMenu("üìÅ Dosya")
        
        new_project_action = QAction(QIcon("icons/new_folder.png"), "Yeni Proje", self)
        new_project_action.setIconVisibleInMenu(True)
        new_project_action.triggered.connect(self.new_project)
        file_menu.addAction(new_project_action)
        
        export_action = QAction(QIcon("icons/export.png"), "Sohbetleri Dƒ±≈üa Aktar", self)
        export_action.setIconVisibleInMenu(True)
        export_action.triggered.connect(self.export_chats)
        file_menu.addAction(export_action)
        
        # Ayarlar Men√ºs√º - Men√º ikonlarƒ±
        settings_menu = menubar.addMenu("‚öôÔ∏è Ayarlar")
        
        theme_action = QAction(QIcon("icons/theme.png"), "üé® Tema Ayarlarƒ±", self)
        theme_action.setIconVisibleInMenu(True)
        theme_action.triggered.connect(self.open_theme_settings)
        settings_menu.addAction(theme_action)
        
        shortcuts_action = QAction(QIcon("icons/keyboard.png"), "‚å®Ô∏è Kƒ±sayollar", self)
        shortcuts_action.setIconVisibleInMenu(True)
        shortcuts_action.triggered.connect(self.open_shortcut_settings)
        settings_menu.addAction(shortcuts_action)

        font_action = QAction(QIcon("icons/settings.png"), "üñãÔ∏è Yazƒ± Tipi", self)
        font_action.setIconVisibleInMenu(True)
        font_action.triggered.connect(self.open_font_settings)
        settings_menu.addAction(font_action)
        
        models_action = QAction(QIcon("icons/model.png"), "ü§ñ Model Y√∂netimi", self)
        models_action.setIconVisibleInMenu(True)
        models_action.triggered.connect(self.open_model_management)
        settings_menu.addAction(models_action)
        
        # Yardƒ±m Men√ºs√º - Men√º ikonlarƒ±
        help_menu = menubar.addMenu("‚ùì Yardƒ±m")
        
        about_action = QAction(QIcon("icons/info.png"), "‚ÑπÔ∏è Hakkƒ±nda", self)
        about_action.setIconVisibleInMenu(True)
        about_action.triggered.connect(self.show_about)
        help_menu.addAction(about_action)
        
        update_action = QAction(QIcon("icons/update.png"), "üîÑ G√ºncellemeleri Kontrol Et", self)
        update_action.setIconVisibleInMenu(True)
        update_action.triggered.connect(self.check_for_updates)
        help_menu.addAction(update_action)

    def minimize_to_tray(self):
        """Uygulamayƒ± tepsiye indir"""
        self.hide()
        self.tray_icon.showMessage(
            "DeepSeek Chat", 
            "Uygulama sistem tepsisinde √ßalƒ±≈ümaya devam ediyor",
            QSystemTrayIcon.MessageIcon.Information, 
            2000
        )

    def setup_shortcuts(self):
        # Enter ile g√∂nder
        self.send_action = QAction(self)
        self.send_action.setShortcut(QKeySequence(Qt.Key.Key_Return | Qt.KeyboardModifier.ControlModifier))
        self.send_action.triggered.connect(self.send_message)
        self.addAction(self.send_action)
        
        # Shift+Enter ile yeni satƒ±r
        self.newline_action = QAction(self)
        self.newline_action.setShortcut(QKeySequence(Qt.Key.Key_Return))
        self.newline_action.triggered.connect(self.insert_newline)
        self.addAction(self.newline_action)
        
        # F11 ile tam ekran
        self.fullscreen_action = QAction(self)
        self.fullscreen_action.setShortcut(QKeySequence("F11"))
        self.fullscreen_action.triggered.connect(self.toggle_fullscreen)
        self.addAction(self.fullscreen_action)
        
        # Ctrl+M ile tepsiye indir
        self.minimize_action = QAction(self)
        self.minimize_action.setShortcut(QKeySequence("Ctrl+M"))
        self.minimize_action.triggered.connect(self.minimize_to_tray)
        self.addAction(self.minimize_action)

        # Mesaj giri≈üine event filter
        self.message_input.installEventFilter(self)

    def eventFilter(self, source, event):
        if source is self.message_input and event.type() == QEvent.Type.KeyPress:
            if event.key() in (Qt.Key.Key_Return, Qt.Key.Key_Enter):
                if not (event.modifiers() & Qt.KeyboardModifier.ShiftModifier):
                    self.send_message()
                    return True
        return super().eventFilter(source, event)

    def apply_theme(self, theme_name):
        try:
            self.current_theme = theme_name
            common_style = """
                QFrame#sidebar {
                    border-right: 2px solid $border_color;
                }
                QSplitter::handle {
                    background-color: $border_color;
                }
            """
            
            if theme_name == "dark":
                style = common_style.replace("$border_color", "#2d2d2d") + """
                    /* Ana Pencere */
                    QMainWindow {
                        background-color: #121212;
                        color: #e0e0e0;
                    }
                    
                    /* Genel Widget'lar */
                    QWidget {
                        background-color: #121212;
                        color: #e0e0e0;
                    }
                    
                    /* Metin Giri≈üleri */
                    QTextEdit, QLineEdit, QListWidget, QTreeWidget {
                        background-color: #1e1e1e;
                        color: #ffffff;
                        border: 1px solid #2d2d2d;
                        border-radius: 6px;
                        padding: 8px;
                        selection-background-color: #4a76cd;
                        selection-color: white;
                    }
                    
                    /* Butonlar */
                    QPushButton {
                        background-color: #2d2d2d;
                        color: #e0e0e0;
                        border: 1px solid #3a3a3a;
                        border-radius: 6px;
                        padding: 8px 12px;
                        min-width: 100px;
                    }
                    
                    QPushButton:hover {
                        background-color: #3a3a3a;
                    }
                    
                    QPushButton:pressed {
                        background-color: #1d1d1d;
                    }
                    
                    QPushButton:checked {
                        background-color: #4a76cd;
                        color: white;
                    }
                    
                    /* A√ßƒ±lƒ±r Men√ºler */
                    QComboBox {
                        background-color: #1e1e1e;
                        color: #ffffff;
                        border: 1px solid #2d2d2d;
                        border-radius: 6px;
                        padding: 5px;
                    }
                    
                    QComboBox::drop-down {
                        subcontrol-origin: padding;
                        subcontrol-position: top right;
                        width: 20px;
                        border-left-width: 1px;
                        border-left-color: #d1d9e6;
                        border-left-style: solid;
                        border-top-right-radius: 6px;
                        border-bottom-right-radius: 6px;
                    }
                    QComboBox::down-arrow {
                        image: url(down_arrow.png);
                        width: 12px;
                        height: 12px;
                    }
                    QComboBox::down-arrow {
                        image: url(down_arrow.png);
                        width: 12px;
                        height: 12px;
                    }
                    
                    /* Sekmeler */
                    QTabWidget::pane {
                        border: 1px solid #2d2d2d;
                        background: #1e1e1e;
                    }
                    
                    QTabBar::tab {
                        background: #2d2d2d;
                        color: #e0e0e0;
                        padding: 8px 12px;
                        border-top-left-radius: 4px;
                        border-top-right-radius: 4px;
                        margin-right: 2px;
                    }
                    
                    QTabBar::tab:selected {
                        background: #4a76cd;
                        color: white;
                    }
                    
                    /* ScrollBar */
                    QScrollBar:vertical {
                        border: none;
                        background: #1e1e1e;
                        width: 10px;
                        margin: 0;
                    }
                    
                    QScrollBar::handle:vertical {
                        background: #3a3a3a;
                        min-height: 20px;
                        border-radius: 5px;
                    }
                    
                    QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {
                        height: 0px;
                    }
                    
                    /* Grup Kutularƒ± */
                    QGroupBox {
                        border: 1px solid #2d2d2d;
                        border-radius: 6px;
                        margin-top: 1ex;
                        padding-top: 10px;
                        font-weight: bold;
                    }
                    
                    QGroupBox::title {
                        subcontrol-origin: margin;
                        subcontrol-position: top center;
                        padding: 0 5px;
                    }
                """
            
            elif theme_name == "light":
                style = common_style.replace("$border_color", "#d1d9e6") + """
                    /* Modern A√ßƒ±k Tema */
                    QMainWindow {
                        background-color: #f5f7fa;
                        color: #333333;
                    }
                    
                    /* Genel Widget'lar */
                    QWidget {
                        background-color: #f5f7fa;
                        color: #333333;
                    }
                    
                    /* Metin Giri≈üleri */
                    QTextEdit, QLineEdit, QListWidget, QTreeWidget {
                        background-color: #ffffff;
                        color: #333333;
                        border: 1px solid #d1d9e6;
                        border-radius: 6px;
                        padding: 8px;
                        selection-background-color: #4a76cd;
                        selection-color: white;
                    }
                    
                    /* Butonlar */
                    QPushButton {
                        background-color: #ffffff;
                        color: #333333;
                        border: 1px solid #d1d9e6;
                        border-radius: 6px;
                        padding: 8px 12px;
                        min-width: 100px;
                    }
                    
                    QPushButton:hover {
                        background-color: #f0f4f9;
                    }
                    
                    QPushButton:pressed {
                        background-color: #e4eaf3;
                    }
                    
                    QPushButton:checked {
                        background-color: #4a76cd;
                        color: white;
                    }
                    
                    /* A√ßƒ±lƒ±r Men√ºler */
                    QComboBox {
                        background-color: #ffffff;
                        color: #333333;
                        border: 1px solid #d1d9e6;
                        border-radius: 6px;
                        padding: 5px;
                    }
                    
                    QComboBox::drop-down {
                        subcontrol-origin: padding;
                        subcontrol-position: top right;
                        width: 20px;
                        border-left-width: 1px;
                        border-left-color: #d1d9e6;
                        border-left-style: solid;
                        border-top-right-radius: 6px;
                        border-bottom-right-radius: 6px;
                    }

                    QComboBox::down-arrow {
                        image: url(icons/down_arrow.png);
                        width: 12px;
                        height: 12px;
                    }
                    
                    /* Sekmeler */
                    QTabWidget::pane {
                        border: 1px solid #d1d9e6;
                        background: #ffffff;
                    }
                    
                    QTabBar::tab {
                        background: #f0f4f9;
                        color: #333333;
                        padding: 8px 12px;
                        border-top-left-radius: 4px;
                        border-top-right-radius: 4px;
                        margin-right: 2px;
                    }
                    
                    QTabBar::tab:selected {
                        background: #4a76cd;
                        color: white;
                    }
                    
                    /* ScrollBar */
                    QScrollBar:vertical {
                        border: none;
                        background: #ffffff;
                        width: 10px;
                        margin: 0;
                    }
                    
                    QScrollBar::handle:vertical {
                        background: #d1d9e6;
                        min-height: 20px;
                        border-radius: 5px;
                    }
                    
                    QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {
                        height: 0px;
                    }
                    
                    /* Grup Kutularƒ± */
                    QGroupBox {
                        border: 1px solid #d1d9e6;
                        border-radius: 6px;
                        margin-top: 1ex;
                        padding-top: 10px;
                        font-weight: bold;
                    }
                    
                    QGroupBox::title {
                        subcontrol-origin: margin;
                        subcontrol-position: top center;
                        padding: 0 5px;
                    }
                """

            elif theme_name == "blue":
                style = common_style.replace("$border_color", "#275a8e") + """
                    QMainWindow { background-color: #1b2e4a; color: #ffffff; }
                    QWidget { background-color: #1b2e4a; color: #ffffff; }
                    QTextEdit, QLineEdit, QListWidget, QTreeWidget {
                        background-color: #223b5f;
                        color: #ffffff;
                        border: 1px solid #275a8e;
                        border-radius: 6px;
                        padding: 8px;
                        selection-background-color: #4a90e2;
                        selection-color: white;
                    }
                    QPushButton {
                        background-color: #275a8e;
                        color: #ffffff;
                        border: 1px solid #2f6ca1;
                        border-radius: 6px;
                        padding: 8px 12px;
                        min-width: 100px;
                    }
                    QPushButton:hover { background-color: #2f6ca1; }
                    QPushButton:pressed { background-color: #1d4a7a; }
                    QPushButton:checked { background-color: #4a90e2; color: white; }
                    QComboBox {
                        background-color: #223b5f;
                        color: #ffffff;
                        border: 1px solid #275a8e;
                        border-radius: 6px;
                        padding: 5px;
                    }
                    QComboBox::drop-down {
                        subcontrol-origin: padding;
                        subcontrol-position: top right;
                        width: 20px;
                        border-left-width: 1px;
                        border-left-color: #275a8e;
                        border-left-style: solid;
                        border-top-right-radius: 6px;
                        border-bottom-right-radius: 6px;
                    }
                    QComboBox::down-arrow {
                        image: url(icons/down_arrow.png);
                        width: 12px;
                        height: 12px;
                    }
                    QTabWidget::pane { border: 1px solid #275a8e; background: #223b5f; }
                    QTabBar::tab { background: #275a8e; color: #ffffff; padding: 8px 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; margin-right: 2px; }
                    QTabBar::tab:selected { background: #4a90e2; color: white; }
                    QScrollBar:vertical { border: none; background: #223b5f; width: 10px; margin: 0; }
                    QScrollBar::handle:vertical { background: #2f6ca1; min-height: 20px; border-radius: 5px; }
                    QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { height: 0px; }
                    QGroupBox { border: 1px solid #275a8e; border-radius: 6px; margin-top: 1ex; padding-top: 10px; font-weight: bold; }
                    QGroupBox::title { subcontrol-origin: margin; subcontrol-position: top center; padding: 0 5px; }
                """

            elif theme_name == "green":
                style = common_style.replace("$border_color", "#2e8b57") + """
                    QMainWindow { background-color: #1f3d2b; color: #ffffff; }
                    QWidget { background-color: #1f3d2b; color: #ffffff; }
                    QTextEdit, QLineEdit, QListWidget, QTreeWidget {
                        background-color: #28543c;
                        color: #ffffff;
                        border: 1px solid #2e8b57;
                        border-radius: 6px;
                        padding: 8px;
                        selection-background-color: #44c77f;
                        selection-color: white;
                    }
                    QPushButton {
                        background-color: #2e8b57;
                        color: #ffffff;
                        border: 1px solid #379b63;
                        border-radius: 6px;
                        padding: 8px 12px;
                        min-width: 100px;
                    }
                    QPushButton:hover { background-color: #379b63; }
                    QPushButton:pressed { background-color: #1f5d3a; }
                    QPushButton:checked { background-color: #44c77f; color: white; }
                    QComboBox {
                        background-color: #28543c;
                        color: #ffffff;
                        border: 1px solid #2e8b57;
                        border-radius: 6px;
                        padding: 5px;
                    }
                    QComboBox::drop-down {
                        subcontrol-origin: padding;
                        subcontrol-position: top right;
                        width: 20px;
                        border-left-width: 1px;
                        border-left-color: #2e8b57;
                        border-left-style: solid;
                        border-top-right-radius: 6px;
                        border-bottom-right-radius: 6px;
                    }
                    QComboBox::down-arrow {
                        image: url(icons/down_arrow.png);
                        width: 12px;
                        height: 12px;
                    }
                    QTabWidget::pane { border: 1px solid #2e8b57; background: #28543c; }
                    QTabBar::tab { background: #2e8b57; color: #ffffff; padding: 8px 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; margin-right: 2px; }
                    QTabBar::tab:selected { background: #44c77f; color: white; }
                    QScrollBar:vertical { border: none; background: #28543c; width: 10px; margin: 0; }
                    QScrollBar::handle:vertical { background: #379b63; min-height: 20px; border-radius: 5px; }
                    QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { height: 0px; }
                    QGroupBox { border: 1px solid #2e8b57; border-radius: 6px; margin-top: 1ex; padding-top: 10px; font-weight: bold; }
                    QGroupBox::title { subcontrol-origin: margin; subcontrol-position: top center; padding: 0 5px; }
                """

            elif theme_name == "purple":
                style = common_style.replace("$border_color", "#8a2be2") + """
                    QMainWindow { background-color: #3d2a5b; color: #ffffff; }
                    QWidget { background-color: #3d2a5b; color: #ffffff; }
                    QTextEdit, QLineEdit, QListWidget, QTreeWidget {
                        background-color: #4a346d;
                        color: #ffffff;
                        border: 1px solid #8a2be2;
                        border-radius: 6px;
                        padding: 8px;
                        selection-background-color: #b366ff;
                        selection-color: white;
                    }
                    QPushButton {
                        background-color: #8a2be2;
                        color: #ffffff;
                        border: 1px solid #9b45e4;
                        border-radius: 6px;
                        padding: 8px 12px;
                        min-width: 100px;
                    }
                    QPushButton:hover { background-color: #9b45e4; }
                    QPushButton:pressed { background-color: #6c1fb8; }
                    QPushButton:checked { background-color: #b366ff; color: white; }
                    QComboBox {
                        background-color: #4a346d;
                        color: #ffffff;
                        border: 1px solid #8a2be2;
                        border-radius: 6px;
                        padding: 5px;
                    }
                    QComboBox::drop-down {
                        subcontrol-origin: padding;
                        subcontrol-position: top right;
                        width: 20px;
                        border-left-width: 1px;
                        border-left-color: #8a2be2;
                        border-left-style: solid;
                        border-top-right-radius: 6px;
                        border-bottom-right-radius: 6px;
                    }
                    QComboBox::down-arrow {
                        image: url(icons/down_arrow.png);
                        width: 12px;
                        height: 12px;
                    }
                    QTabWidget::pane { border: 1px solid #8a2be2; background: #4a346d; }
                    QTabBar::tab { background: #8a2be2; color: #ffffff; padding: 8px 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; margin-right: 2px; }
                    QTabBar::tab:selected { background: #b366ff; color: white; }
                    QScrollBar:vertical { border: none; background: #4a346d; width: 10px; margin: 0; }
                    QScrollBar::handle:vertical { background: #9b45e4; min-height: 20px; border-radius: 5px; }
                    QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { height: 0px; }
                    QGroupBox { border: 1px solid #8a2be2; border-radius: 6px; margin-top: 1ex; padding-top: 10px; font-weight: bold; }
                    QGroupBox::title { subcontrol-origin: margin; subcontrol-position: top center; padding: 0 5px; }
                """

            else:
                style = ""

            self.setStyleSheet(style)

            checked_style = "background-color: #4a76cd; color: white;"
            self.deep_thought_btn.setStyleSheet(f"QPushButton:checked {{{checked_style}}}")
            self.web_search_btn.setStyleSheet(f"QPushButton:checked {{{checked_style}}}")
        except Exception as e:
            logger.error(f"Tema uygulanirken hata: {str(e)}")

    def apply_font_settings(self):
        try:
            font = QFont(self.font_family, self.font_size)
            self.chat_display.setFont(font)
            self.message_input.setFont(font)
        except Exception as e:
            logger.error(f"Yazƒ± tipi uygulanirken hata: {str(e)}")
            
    def chat_order_changed(self):
        """Sohbet sƒ±rasƒ± deƒüi≈ütiƒüinde kaydet"""
        self.save_app_state()
            
    def filter_chats(self, text):
        """Sohbetleri filtrele (projeler dahil)"""
        text = text.lower()
        
        # Standart sohbet listesi
        for i in range(self.chat_list.count()):
            item = self.chat_list.item(i)
            item_text = item.text().lower()
            item.setHidden(text not in item_text)
        
        # Proje aƒüacƒ±
        for i in range(self.projects_tree.topLevelItemCount()):
            project = self.projects_tree.topLevelItem(i)
            project_visible = False
            
            for j in range(project.childCount()):
                chat_item = project.child(j)
                chat_text = chat_item.text(0).lower()
                if text in chat_text:
                    project_visible = True
                    chat_item.setHidden(False)
                    # E≈üle≈üme bulunduƒüunda projeyi geni≈ület
                    project.setExpanded(True)
                else:
                    chat_item.setHidden(True)
            
            project.setHidden(not project_visible)

    def load_chat(self, item):
        try:
            chat_id = item.data(Qt.ItemDataRole.UserRole)
            if chat_id not in self.chat_data:
                self.chat_data[chat_id] = {
                    "title": item.text(),
                    "messages": []
                }
            
            # Mesajlarƒ± y√ºkle
            self.chat_display.clear()
            for msg in self.chat_data[chat_id]["messages"]:
                self.append_message(msg["sender"], msg["message"])
            
            self.active_chat_id = chat_id
            self.statusBar().showMessage(f"üí¨ {item.text()} y√ºklendi", 3000)
            
            # Sidebar'da se√ßili hale getir
            self.chat_list.setCurrentItem(item)
            
            # Aktif modeli g√∂ster
            model_name = self.model_combo.currentText()
            self.statusBar().showMessage(f"ü§ñ Aktif Model: {model_name}", 5000)
        except Exception as e:
            logger.error(f"Sohbet y√ºklenirken hata: {str(e)}")

    def load_project_chat(self, item, column):
        try:
            if item.parent():  # Sadece alt √∂ƒüelerde (sohbetlerde) i≈ülem yap
                chat_id = item.data(0, Qt.ItemDataRole.UserRole)
                if not chat_id:
                    chat_id = str(uuid.uuid4())
                    item.setData(0, Qt.ItemDataRole.UserRole, chat_id)
                
                if chat_id not in self.chat_data:
                    self.chat_data[chat_id] = {
                        "title": item.text(0),
                        "messages": []
                    }
                
                # Mesajlarƒ± y√ºkle
                self.chat_display.clear()
                for msg in self.chat_data[chat_id]["messages"]:
                    self.append_message(msg["sender"], msg["message"])
                
                self.active_chat_id = chat_id
                project_name = item.parent().text(0)
                self.statusBar().showMessage(f"üìÇ {project_name} > {item.text(0)} y√ºklendi", 3000)
                
                # Aƒüa√ßta se√ßili hale getir
                self.projects_tree.setCurrentItem(item)
                
                # Aktif modeli g√∂ster
                model_name = self.model_combo.currentText()
                self.statusBar().showMessage(f"ü§ñ Aktif Model: {model_name}", 5000)
        except Exception as e:
            logger.error(f"Proje sohbeti y√ºklenirken hata: {str(e)}")

    def new_chat(self):
        try:
            # Bo≈ü "Yeni Sohbet" var mƒ± kontrol et
            for i in range(self.chat_list.count()):
                item = self.chat_list.item(i)
                if item.text().startswith("Yeni Sohbet") and not self.chat_data.get(item.data(Qt.ItemDataRole.UserRole), {}).get("messages", []):
                    self.chat_list.setCurrentItem(item)
                    self.load_chat(item)
                    self.statusBar().showMessage("üìù Mevcut yeni sohbet se√ßildi", 3000)
                    return
            
            # Yeni sohbet √∂ƒüesi olu≈ütur
            chat_count = self.chat_list.count() + 1
            chat_name = f"Yeni Sohbet {chat_count}"
            chat_id = str(uuid.uuid4())
            
            item = QListWidgetItem(chat_name)
            item.setData(Qt.ItemDataRole.UserRole, chat_id)
            item.setFlags(item.flags() | Qt.ItemFlag.ItemIsEditable)
            self.chat_list.addItem(item)
            
            # Yeni sohbet verisini olu≈ütur
            self.chat_data[chat_id] = {
                "title": chat_name,
                "messages": []
            }
            
            # Son eklenen √∂ƒüeyi se√ß
            self.chat_list.setCurrentItem(item)
            self.active_chat_id = chat_id
            
            # Sohbeti y√ºkle
            self.chat_display.setHtml("<center><i>Merhaba, size nasƒ±l yardƒ±mcƒ± olabilirim?</i></center>")
            self.statusBar().showMessage("üÜï Yeni sohbet ba≈ülatƒ±ldƒ±", 3000)
            
            # Uygulama durumunu kaydet
            self.save_app_state()
        except Exception as e:
            logger.error(f"Yeni sohbet olu≈üturulurken hata: {str(e)}")

    def edit_chat_title(self, item):
        """Sohbet ba≈ülƒ±ƒüƒ±nƒ± d√ºzenle"""
        try:
            self.chat_list.editItem(item)
            if item.data(Qt.ItemDataRole.UserRole) in self.chat_data:
                self.chat_data[item.data(Qt.ItemDataRole.UserRole)]["title"] = item.text()
            self.save_app_state()
        except Exception as e:
            logger.error(f"Sohbet ba≈ülƒ±ƒüƒ± d√ºzenlenirken hata: {str(e)}")

    def update_chat_title(self, chat_id, new_title):
        """Sohbet ba≈ülƒ±ƒüƒ±nƒ± t√ºm listelerde g√ºncelle"""
        for i in range(self.chat_list.count()):
            item = self.chat_list.item(i)
            if item.data(Qt.ItemDataRole.UserRole) == chat_id:
                item.setText(new_title)
                break

        def update_tree(item):
            if item.data(0, Qt.ItemDataRole.UserRole) == chat_id:
                item.setText(0, f"üí¨ {new_title}")
                return True
            for j in range(item.childCount()):
                if update_tree(item.child(j)):
                    return True
            return False

        for i in range(self.projects_tree.topLevelItemCount()):
            update_tree(self.projects_tree.topLevelItem(i))

        if chat_id in self.chat_data:
            self.chat_data[chat_id]["title"] = new_title
        self.save_app_state()

    def new_project(self):
        try:
            project_name, ok = QInputDialog.getText(self, "Yeni Proje", "Proje Adƒ±:")
            if ok and project_name:
                # Yeni proje olu≈ütur
                new_project = QTreeWidgetItem([f"üìÇ {project_name}"])
                new_project.setFlags(new_project.flags() | Qt.ItemFlag.ItemIsEditable)
                

                
                # Aƒüaca ekle
                self.projects_tree.addTopLevelItem(new_project)
                
                # Projeyi geni≈ület
                new_project.setExpanded(True)
                
                # Projeyi se√ß
                self.projects_tree.setCurrentItem(new_project)
                self.chat_display.setHtml("<center><i>Merhaba, size nasƒ±l yardƒ±mcƒ± olabilirim?</i></center>")
                
                self.statusBar().showMessage(f"üÜï Yeni proje olu≈üturuldu: {project_name}", 3000)
                self.save_app_state()
        except Exception as e:
            logger.error(f"Yeni proje olu≈üturulurken hata: {str(e)}")

    def edit_project_title(self, item, column):
        """Proje ba≈ülƒ±ƒüƒ±nƒ± d√ºzenle"""
        try:
            if item:
                self.projects_tree.editItem(item, column)
                if item.parent():
                    chat_id = item.data(0, Qt.ItemDataRole.UserRole)
                    if chat_id and chat_id in self.chat_data:
                        self.chat_data[chat_id]["title"] = item.text(0).replace("üí¨ ", "")
                self.save_app_state()
        except Exception as e:
            logger.error(f"Proje ba≈ülƒ±ƒüƒ± d√ºzenlenirken hata: {str(e)}")

    def show_project_context_menu(self, pos):
        """Proje baƒülam men√ºs√º (silme)"""
        try:
            item = self.projects_tree.itemAt(pos)
            if item:
                menu = QMenu()
                
                # Proje √∂ƒüesi ise
                if not item.parent():
                    delete_action = menu.addAction(QIcon("icons/delete.png"), "Projeyi Sil")
                    delete_action.triggered.connect(lambda: self.delete_project(item))
                    
                    add_chat_action = menu.addAction(QIcon("icons/add_chat.png"), "Sohbet Ekle")
                    add_chat_action.triggered.connect(lambda: self.add_chat_to_project(item))
                
                # Sohbet √∂ƒüesi ise
                else:
                    delete_action = menu.addAction(QIcon("icons/delete.png"), "Sohbeti Sil")
                    delete_action.triggered.connect(lambda: self.delete_project_chat(item))

                    rename_action = menu.addAction(QIcon("icons/rename.png"), "Yeniden Adlandƒ±r")
                    rename_action.triggered.connect(lambda: self.projects_tree.editItem(item, 0))

                    export_action = menu.addAction(QIcon("icons/export.png"), "Dƒ±≈üa Aktar")
                    export_action.triggered.connect(self.export_selected_chat)
                    
                    move_menu = menu.addMenu(QIcon("icons/move.png"), "Projeye Ta≈üƒ±")
                    for i in range(self.projects_tree.topLevelItemCount()):
                        project = self.projects_tree.topLevelItem(i)
                        if project != item.parent():
                            move_action = move_menu.addAction(project.text(0))
                            move_action.triggered.connect(
                                lambda _, p=project, c=item: self.move_chat_to_project(p, c)
                            )
                
                menu.exec(self.projects_tree.mapToGlobal(pos))
        except Exception as e:
            logger.error(f"Baƒülam men√ºs√º g√∂sterilirken hata: {str(e)}")

    def add_chat_to_project(self, project_item):
        """Projeye yeni sohbet ekle"""
        try:
            chat_count = project_item.childCount() + 1
            chat_name = f"Yeni Sohbet {chat_count}"
            chat_id = str(uuid.uuid4())
            
            new_chat = QTreeWidgetItem([f"üí¨ {chat_name}"])
            new_chat.setData(0, Qt.ItemDataRole.UserRole, chat_id)
            new_chat.setFlags(new_chat.flags() | Qt.ItemFlag.ItemIsEditable)
            project_item.addChild(new_chat)
            project_item.setExpanded(True)
            
            # Yeni sohbet verisini olu≈ütur
            self.chat_data[chat_id] = {
                "title": chat_name,
                "messages": []
            }
            
            # Ba≈ülƒ±ƒüƒ± d√ºzenlemek i√ßin a√ß
            self.projects_tree.editItem(new_chat, 0)
            self.save_app_state()
        except Exception as e:
            logger.error(f"Projeye sohbet eklenirken hata: {str(e)}")

    def delete_project(self, item):
        """Projeyi sil"""
        try:
            if not item.parent():  # Sadece projeleri sil
                # Alt sohbetleri sil
                for i in range(item.childCount()):
                    child = item.child(i)
                    chat_id = child.data(0, Qt.ItemDataRole.UserRole)
                    if chat_id in self.chat_data:
                        del self.chat_data[chat_id]
                
                root = self.projects_tree.invisibleRootItem()
                (root if item.parent() is None else item.parent()).removeChild(item)
                self.statusBar().showMessage("üóëÔ∏è Proje silindi", 3000)
                self.save_app_state()
        except Exception as e:
            logger.error(f"Proje silinirken hata: {str(e)}")
    
    def delete_project_chat(self, item):
        """Projedeki sohbeti sil"""
        try:
            chat_id = item.data(0, Qt.ItemDataRole.UserRole)
            if chat_id in self.chat_data:
                del self.chat_data[chat_id]
            parent = item.parent()
            parent.removeChild(item)
            self.statusBar().showMessage("üóëÔ∏è Proje sohbeti silindi", 3000)
            self.save_app_state()
        except Exception as e:
            logger.error(f"Proje sohbeti silinirken hata: {str(e)}")

    def load_api_key(self):
        """Kayƒ±tlƒ± API anahtarƒ±nƒ± y√ºkle"""
        try:
            if os.path.exists("api_config.json"):
                with open("api_config.json", "r") as f:
                    config = json.load(f)
                    self.api_key = config.get("api_key")
        except Exception as e:
            logger.error(f"API anahtarƒ± y√ºklenirken hata: {str(e)}")

    def save_api_key(self, api_key):
        """API anahtarƒ±nƒ± kaydet"""
        try:
            with open("api_config.json", "w") as f:
                json.dump({"api_key": api_key}, f)
            self.api_key = api_key
            self.statusBar().showMessage("üîë API anahtarƒ± kaydedildi", 3000)
        except Exception as e:
            logger.error(f"API anahtarƒ± kaydedilirken hata: {str(e)}")

    def get_response_from_openrouter(self, model_name):
        """OpenRouter API'sinden yanƒ±t al"""
        try:
            url = f"{self.api_base_url}/chat/completions"
            headers = {
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json",
                "HTTP-Referer": "https://github.com/CxReiS/DeepSeekChat",
                "X-Title": "DeepSeek Chat"
            }

            # Sohbet ge√ßmi≈üini hazƒ±rla
            messages = []
            for msg in self.chat_data[self.active_chat_id]["messages"]:
                role = "user" if msg["sender"] == "user" else "assistant"
                messages.append({"role": role, "content": msg["message"]})

            # OpenRouter model ID'sini al
            openrouter_model = self.model_mapping.get(model_name, "deepseek/deepseek-r1:free")

            data = {
                "model": openrouter_model,
                "messages": messages,
                "temperature": 0.7,
                "max_tokens": 4096
            }

            response = requests.post(url, headers=headers, json=data, timeout=120)
            response_data = response.json()

            if response.status_code == 200:
                assistant_reply = response_data["choices"][0]["message"]["content"]

                # Yanƒ±tƒ± ekrana ve hafƒ±zaya ekle
                self.append_message("assistant", assistant_reply)
                self.chat_data[self.active_chat_id]["messages"].append({
                    "sender": "assistant",
                    "message": assistant_reply,
                    "timestamp": QDateTime.currentDateTime().toString(Qt.DateFormat.ISODate)
                })

                self.statusBar().showMessage(f"‚úÖ Yanƒ±t alƒ±ndƒ± ({model_name})", 3000)
                self.save_app_state()
            else:
                error_msg = response_data.get("error", {}).get("message", "Bilinmeyen hata")
                self.statusBar().showMessage(f"‚ùå Hata: {error_msg}", 5000)
                logger.error(f"API hatasƒ±: {response.status_code} - {error_msg}")

                # Hata durumunda sim√ºlasyon yap
                QTimer.singleShot(1500, lambda: self.simulate_response(model_name))

        except Exception as e:
            logger.error(f"API isteƒüi sƒ±rasƒ±nda hata: {str(e)}")
            self.statusBar().showMessage(f"‚ùå ƒ∞stek hatasƒ±: {str(e)}", 5000)

            # Hata durumunda sim√ºlasyon yap
            QTimer.singleShot(1500, lambda: self.simulate_response(model_name))

    def send_message(self):
        try:
            message = self.message_input.toPlainText().strip()
            if not message and not self.attached_files:
                return
                
            if not self.active_chat_id:
                QMessageBox.warning(self, "Uyarƒ±", "L√ºtfen √∂nce bir sohbet se√ßin")
                return
                
            # Ekli dosyalarƒ± mesaja dahil et
            for file_path in self.attached_files:
                file_name = os.path.basename(file_path)
                message += f"\n\n[üìé Ek: {file_name}]"
            
            # Kullanƒ±cƒ± mesajƒ±nƒ± ekrana ve hafƒ±zaya ekle
            self.append_message("user", message)
            self.chat_data[self.active_chat_id]["messages"].append({
                "sender": "user",
                "message": message,
                "timestamp": QDateTime.currentDateTime().toString(Qt.DateFormat.ISODate)
            })

            if len(self.chat_data[self.active_chat_id]["messages"]) == 1:
                words = message.split()[:4]
                new_title = " ".join(words)
                if len(new_title) > 25:
                    new_title = new_title[:22] + "..."
                self.update_chat_title(self.active_chat_id, new_title)
            
            self.message_input.clear()
            
            # Aktif modeli al
            model_name = self.model_combo.currentText()

            # API i≈ü par√ßacƒ±ƒüƒ±
            self.worker = WorkerThread(
                api_key="demo-key",
                conversation_history=[{"role": msg['sender'], "content": msg['message']} for msg in self.chat_data[self.active_chat_id]["messages"]],
                user_message=message,
                model=model_name
            )
            self.worker.thinking_updated.connect(self.handle_thinking_update)
            self.worker.response_received.connect(lambda reply, t: self.handle_api_response(reply, model_name))
            self.worker.error_occurred.connect(lambda err: self.statusBar().showMessage(err, 5000))
            self.worker.start()

            self.statusBar().showMessage("‚è≥ DeepSeek yanƒ±t olu≈üturuyor...")

            if self.api_key:
                history = []
                for msg in self.chat_data[self.active_chat_id]["messages"]:
                    role = "user" if msg["sender"] == "user" else "assistant"
                    history.append({"role": role, "content": msg["message"]})
                self.worker = WorkerThread(self.api_key, history, self.model_mapping.get(model_name, "deepseek/deepseek-r1:free"))
                self.worker.response_received.connect(lambda reply, _: self.handle_api_response(reply, model_name))
                self.worker.error_occurred.connect(lambda err: self.handle_api_error(err, model_name))
                self.worker.start()
            else:
                QTimer.singleShot(1500, lambda: self.simulate_response(model_name))
            
            # Ekli dosyalarƒ± temizle
            self.attached_files = []
            
            # Uygulama durumunu kaydet
            self.save_app_state()
        except Exception as e:
            logger.error(f"Mesaj g√∂nderilirken hata: {str(e)}")

    def handle_api_response(self, reply, model_name):
        try:
            self.append_message("assistant", reply)
            self.chat_data[self.active_chat_id]["messages"].append({
                "sender": "assistant",
                "message": reply,
                "timestamp": QDateTime.currentDateTime().toString(Qt.DateFormat.ISODate),
            })
            self.statusBar().showMessage(f"‚úÖ Yanƒ±t alƒ±ndƒ± ({model_name})", 3000)
            self.save_app_state()
        except Exception as e:
            logger.error(f"Yanƒ±t i≈ülenirken hata: {str(e)}")

    def handle_api_error(self, error_msg, model_name):
        logger.error(f"API hatasƒ±: {error_msg}")
        self.statusBar().showMessage(f"‚ùå Hata: {error_msg}", 5000)
        QTimer.singleShot(1500, lambda: self.simulate_response(model_name))

    def simulate_response(self, model_name):
        try:
            if not self.active_chat_id:
                return
                
            response = f"Bu bir sim√ºle edilmi≈ü yanƒ±ttƒ±r ({model_name}). Ger√ßek uygulamada API'den yanƒ±t alƒ±nacaktƒ±r."
            
            # Yanƒ±tƒ± ekrana ve hafƒ±zaya ekle
            self.append_message("assistant", response)
            self.chat_data[self.active_chat_id]["messages"].append({
                "sender": "assistant",
                "message": response,
                "timestamp": QDateTime.currentDateTime().toString(Qt.DateFormat.ISODate)
            })
            
            self.statusBar().showMessage(f"‚úÖ Yanƒ±t alƒ±ndƒ± ({model_name})", 3000)
            self.save_app_state()
        except Exception as e:
            logger.error(f"Yanƒ±t sim√ºle edilirken hata: {str(e)}")

    def handle_thinking_update(self, message):
        cursor = self.chat_display.textCursor()
        cursor.select(QTextCursor.SelectionType.Document)
        cursor.removeSelectedText()
        dimmed_color = "#888888" if self.current_theme == "light" else "#aaaaaa"
        html_content = f"<div style='color:{dimmed_color}; font-style:italic; margin-bottom:15px;'>{message}</div>"
        self.chat_display.insertHtml(html_content)
        self.chat_display.ensureCursorVisible()

    def handle_api_response(self, reply, model_name):
        self.chat_display.clear()
        self.append_message("assistant", reply)
        if self.active_chat_id:
            self.chat_data[self.active_chat_id]["messages"].append({
                "sender": "assistant",
                "message": reply,
                "timestamp": QDateTime.currentDateTime().toString(Qt.DateFormat.ISODate),
            })
            self.save_app_state()

    def model_changed(self, index):
        model_name = self.model_combo.currentText()
        self.statusBar().showMessage(f"ü§ñ Aktif model: {model_name}", 5000)
        if "coder" in model_name:
            self.message_input.setPlaceholderText("Kod problemini yazƒ±n...")
        elif "math" in model_name:
            self.message_input.setPlaceholderText("Matematik problemini yazƒ±n...")
        else:
            self.message_input.setPlaceholderText("DeepSeek'e mesaj yazƒ±n...")

    def append_message(self, sender, message):
        try:
            cursor = self.chat_display.textCursor()
            cursor.movePosition(QTextCursor.MoveOperation.End)

            if sender == "user":
                prefix = "Siz:"
                color = "#4ec9b0"
                bg_color = "#1e1e1e" if self.current_theme == "dark" else "#f0f4f9"
            else:
                prefix = "DeepSeek:"
                color = "#d69a66"
                bg_color = "#2a2a2a" if self.current_theme == "dark" else "#ffffff"

            weight = "bold" if self.label_bold else "normal"
            style_italic = "italic" if self.italic_subtitles else "normal"

            html_content = f"""
            <div style='margin-bottom:20px; padding:10px; background-color:{bg_color}; border-radius:8px;'>
                <span style='font-weight:{weight}; color:{color}; font-style:{style_italic};'>{prefix}</span>
                <div style='margin-top:5px; line-height:1.6; font-family:{self.font_family}; font-size:{self.font_size}px;'>
                    {message}
                </div>
            </div>
            """

            self.chat_display.insertHtml(html_content)
            self.chat_display.ensureCursorVisible()
        except Exception as e:
            logger.error(f"Mesaj eklenirken hata: {str(e)}")

    def insert_newline(self):
        try:
            self.message_input.insertPlainText("\n")
        except Exception as e:
            logger.error(f"Yeni satƒ±r eklenirken hata: {str(e)}")

    def toggle_fullscreen(self):
        try:
            if self.isFullScreen():
                self.showNormal()
            else:
                self.showFullScreen()
        except Exception as e:
            logger.error(f"Tam ekran deƒüi≈ütirilirken hata: {str(e)}")

    def attach_file(self):
        try:
            if len(self.attached_files) >= 10:
                QMessageBox.warning(self, "Uyarƒ±", "En fazla 10 dosya ekleyebilirsiniz")
                return

            file_path, _ = QFileDialog.getOpenFileName(self, "Dosya Se√ß", "", "T√ºm Dosyalar (*)")
            if file_path:
                valid_extensions = ['.txt', '.py', '.js', '.html', '.css', '.json', '.pdf', '.doc', '.docx', '.md']
                if not any(file_path.lower().endswith(ext) for ext in valid_extensions):
                    QMessageBox.warning(self, "Desteklenmeyen Dosya", "Se√ßilen dosya tipi desteklenmiyor. L√ºtfen metin tabanlƒ± dosyalar ekleyin.")
                    return

                file_name = os.path.basename(file_path)
                self.attached_files.append(file_path)

                file_widget = QWidget()
                layout = QHBoxLayout(file_widget)
                layout.setContentsMargins(0, 0, 0, 0)
                label = QLabel(f"üìé {file_name}")
                layout.addWidget(label)
                remove_btn = QPushButton("‚úï")
                remove_btn.setFixedSize(20, 20)
                remove_btn.setStyleSheet("font-size: 10px; padding: 0;")
                remove_btn.clicked.connect(lambda _, p=file_path: self.remove_attached_file(p))
                layout.addWidget(remove_btn)

                item = QListWidgetItem()
                item.setSizeHint(file_widget.sizeHint())
                self.attachments_list.addItem(item)
                self.attachments_list.setItemWidget(item, file_widget)
        except Exception as e:
            logger.error(f"Dosya eklenirken hata: {str(e)}")

    def remove_attached_file(self, file_path):
        if file_path in self.attached_files:
            self.attached_files.remove(file_path)
            self.refresh_attachments_list()

    def refresh_attachments_list(self):
        self.attachments_list.clear()
        for path in self.attached_files:
            file_name = os.path.basename(path)
            file_widget = QWidget()
            layout = QHBoxLayout(file_widget)
            layout.setContentsMargins(0, 0, 0, 0)
            label = QLabel(f"üìé {file_name}")
            layout.addWidget(label)
            remove_btn = QPushButton("‚úï")
            remove_btn.setFixedSize(20, 20)
            remove_btn.setStyleSheet("font-size: 10px; padding: 0;")
            remove_btn.clicked.connect(lambda _, p=path: self.remove_attached_file(p))
            layout.addWidget(remove_btn)
            item = QListWidgetItem()
            item.setSizeHint(file_widget.sizeHint())
            self.attachments_list.addItem(item)
            self.attachments_list.setItemWidget(item, file_widget)

    def eventFilter(self, source, event):
        if source is self.message_input:
            if event.type() == QEvent.Type.KeyPress and event.key() in [Qt.Key.Key_Return, Qt.Key.Key_Enter]:
                if not (event.modifiers() & Qt.KeyboardModifier.ShiftModifier):
                    self.send_message()
                    return True
            if event.type() == QEvent.Type.DragEnter and event.mimeData().hasUrls():
                event.acceptProposedAction()
                return True
            if event.type() == QEvent.Type.Drop and event.mimeData().hasUrls():
                for url in event.mimeData().urls():
                    file_path = url.toLocalFile()
                    if os.path.isfile(file_path):
                        if len(self.attached_files) >= 10:
                            QMessageBox.warning(self, "Uyarƒ±", "En fazla 10 dosya ekleyebilirsiniz")
                            break
                        valid_extensions = ['.txt', '.py', '.js', '.html', '.css', '.json', '.pdf', '.doc', '.docx', '.md']
                        if not any(file_path.lower().endswith(ext) for ext in valid_extensions):
                            QMessageBox.warning(self, "Desteklenmeyen Dosya", "Se√ßilen dosya tipi desteklenmiyor. L√ºtfen metin tabanlƒ± dosyalar ekleyin.")
                            continue
                        self.attached_files.append(file_path)
                        file_name = os.path.basename(file_path)
                        file_widget = QWidget()
                        layout = QHBoxLayout(file_widget)
                        layout.setContentsMargins(0, 0, 0, 0)
                        label = QLabel(f"üìé {file_name}")
                        layout.addWidget(label)
                        remove_btn = QPushButton("‚úï")
                        remove_btn.setFixedSize(20, 20)
                        remove_btn.setStyleSheet("font-size: 10px; padding: 0;")
                        remove_btn.clicked.connect(lambda _, p=file_path: self.remove_attached_file(p))
                        layout.addWidget(remove_btn)
                        item = QListWidgetItem()
                        item.setSizeHint(file_widget.sizeHint())
                        self.attachments_list.addItem(item)
                        self.attachments_list.setItemWidget(item, file_widget)
                event.acceptProposedAction()
                return True
        return super().eventFilter(source, event)

    def export_chats(self):
        try:
            file_path, _ = QFileDialog.getSaveFileName(
                self, 
                "Sohbetleri Dƒ±≈üa Aktar", 
                "", 
                "JSON Dosyalarƒ± (*.json);;T√ºm Dosyalar (*)"
            )
            
            if file_path:
                export_data = {
                    "version": self.VERSION,
                    "export_date": QDateTime.currentDateTime().toString(Qt.DateFormat.ISODate),
                    "chats": {}
                }

                for cid, data in self.chat_data.items():
                    clean_msgs = []
                    for m in data["messages"]:
                        clean = m.copy()
                        clean["message"] = self.sanitize_text(m["message"])
                        clean_msgs.append(clean)
                    export_data["chats"][cid] = {"title": data["title"], "messages": clean_msgs}

                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(export_data, f, indent=2, ensure_ascii=False)
                
                self.statusBar().showMessage(f"üì§ Sohbetler dƒ±≈üa aktarƒ±ldƒ±: {file_path}", 5000)
        except Exception as e:
            logger.error(f"Sohbetler dƒ±≈üa aktarƒ±lƒ±rken hata: {str(e)}")
            QMessageBox.critical(self, "Hata", f"Sohbetler dƒ±≈üa aktarƒ±lƒ±rken hata olu≈ütu: {str(e)}")

    def export_selected_chat(self):
        """Yalnƒ±zca se√ßili sohbeti dƒ±≈üa aktar"""
        try:
            if not self.active_chat_id or self.active_chat_id not in self.chat_data:
                return

            file_path, _ = QFileDialog.getSaveFileName(
                self,
                "Sohbeti Dƒ±≈üa Aktar",
                "",
                "JSON Dosyalarƒ± (*.json);;T√ºm Dosyalar (*)"
            )
            if not file_path:
                return

            export_data = {
                "version": self.VERSION,
                "export_date": QDateTime.currentDateTime().toString(Qt.DateFormat.ISODate),
                "chat": self.chat_data[self.active_chat_id]
            }

            with open(file_path, 'w') as f:
                json.dump(export_data, f, indent=2, ensure_ascii=False)

            self.statusBar().showMessage(f"üì§ Sohbet dƒ±≈üa aktarƒ±ldƒ±: {file_path}", 5000)
        except Exception as e:
            logger.error(f"Sohbet dƒ±≈üa aktarƒ±lƒ±rken hata: {str(e)}")
            QMessageBox.critical(self, "Hata", f"Sohbet dƒ±≈üa aktarƒ±lƒ±rken hata olu≈ütu: {str(e)}")

    def export_selected_chat(self):
        if self.active_chat_id and self.active_chat_id in self.chat_data:
            self.export_chats()

    def sanitize_text(self, text):
        return re.sub(r"[\U0001F600-\U0001F6FF]", "", text)

    def open_theme_settings(self):
        try:
            dialog = QDialog(self)
            dialog.setWindowTitle("üé® Tema Ayarlarƒ±")
            dialog.setFixedSize(400, 300)
            
            layout = QVBoxLayout()
            
            # Tema se√ßimi i√ßin butonlar
            theme_buttons = QWidget()
            grid = QGridLayout(theme_buttons)
            
            themes = [
                ("üåô Koyu Tema", "dark"),
                ("‚òÄÔ∏è A√ßƒ±k Tema", "light"),
                ("üîµ Mavi Tema", "blue"),
                ("üçè Ye≈üil Tema", "green"),
                ("üçá Mor Tema", "purple")
            ]
            
            row, col = 0, 0
            for theme_name, theme_key in themes:
                btn = QPushButton(theme_name)
                btn.clicked.connect(lambda _, t=theme_key: self.apply_theme(t))
                grid.addWidget(btn, row, col)
                col += 1
                if col > 1:
                    col = 0
                    row += 1
            
            layout.addWidget(theme_buttons)
            
            # Kapat butonu
            btn_box = QDialogButtonBox(QDialogButtonBox.StandardButton.Close)
            btn_box.rejected.connect(dialog.reject)
            layout.addWidget(btn_box)
            
            dialog.setLayout(layout)
            dialog.exec()
        except Exception as e:
            logger.error(f"Tema ayarlarƒ± a√ßƒ±lƒ±rken hata: {str(e)}")
            QMessageBox.critical(self, "Hata", f"Tema ayarlarƒ± a√ßƒ±lƒ±rken hata olu≈ütu: {str(e)}")
            
    def open_shortcut_settings(self):
        try:
            dialog = QDialog(self)
            dialog.setWindowTitle("‚å®Ô∏è Kƒ±sayol Ayarlarƒ±")
            dialog.setFixedSize(400, 300)
            
            tabs = QTabWidget()
            
            # Genel kƒ±sayollar
            general_tab = QWidget()
            form = QFormLayout(general_tab)
            
            # Mesaj g√∂nder kƒ±sayolu
            send_key_edit = QKeySequenceEdit(self.send_action.shortcut())
            form.addRow("Mesaj G√∂nder (Ctrl+Enter):", send_key_edit)
            
            # Yeni satƒ±r kƒ±sayolu
            newline_key_edit = QKeySequenceEdit(self.newline_action.shortcut())
            form.addRow("Yeni Satƒ±r (Enter):", newline_key_edit)
            
            # Tam ekran kƒ±sayolu
            fullscreen_key_edit = QKeySequenceEdit(self.fullscreen_action.shortcut())
            form.addRow("Tam Ekran:", fullscreen_key_edit)
            
            # Tepsiye indirme kƒ±sayolu
            minimize_key_edit = QKeySequenceEdit(self.minimize_action.shortcut())
            form.addRow("Tepsiye ƒ∞ndir:", minimize_key_edit)
            
            tabs.addTab(general_tab, "Genel")
            
            layout = QVBoxLayout()
            layout.addWidget(tabs)
            
            # Kaydet butonu
            buttons = QDialogButtonBox(QDialogButtonBox.StandardButton.Save | QDialogButtonBox.StandardButton.Cancel)
            buttons.button(QDialogButtonBox.StandardButton.Save).setText("Kaydet")
            buttons.button(QDialogButtonBox.StandardButton.Cancel).setText("ƒ∞ptal")
            buttons.accepted.connect(lambda: self.save_shortcuts(
                send_key_edit.keySequence(),
                newline_key_edit.keySequence(),
                fullscreen_key_edit.keySequence(),
                minimize_key_edit.keySequence(),
                dialog  # Diyaloƒüu kapatmak i√ßin
            ))
            buttons.rejected.connect(dialog.reject)
            layout.addWidget(buttons)
            
            dialog.setLayout(layout)
            dialog.exec()
        except Exception as e:
            logger.error(f"Kƒ±sayol ayarlarƒ± a√ßƒ±lƒ±rken hata: {str(e)}")

    def save_shortcuts(self, send_seq, newline_seq, fullscreen_seq, minimize_seq, dialog):
        try:
            # Kƒ±sayollarƒ± g√ºncelle
            self.send_action.setShortcut(send_seq)
            self.newline_action.setShortcut(newline_seq)
            self.fullscreen_action.setShortcut(fullscreen_seq)
            self.minimize_action.setShortcut(minimize_seq)
            
            self.statusBar().showMessage("‚úÖ Kƒ±sayollar kaydedildi", 3000)
            self.save_app_state()
            dialog.accept()  # Diyaloƒüu kapat
        except Exception as e:
            logger.error(f"Kƒ±sayollar kaydedilirken hata: {str(e)}")
            QMessageBox.critical(self, "Hata", f"Kƒ±sayollar kaydedilirken hata olu≈ütu: {str(e)}")

    def open_font_settings(self):
        try:
            dialog = QDialog(self)
            dialog.setWindowTitle("üìù Yazƒ± Tipi Ayarlarƒ±")
            dialog.setFixedSize(400, 300)

            layout = QVBoxLayout()

            family_combo = QFontComboBox()
            family_combo.setCurrentFont(QFont(self.font_family))

            size_slider = QSlider(Qt.Orientation.Horizontal)
            size_slider.setRange(12, 24)
            size_slider.setValue(self.font_size)

            bold_check = QCheckBox("Kalƒ±n ba≈ülƒ±klar")
            bold_check.setChecked(self.label_bold)

            italic_check = QCheckBox("ƒ∞talik altyazƒ±lar")
            italic_check.setChecked(self.italic_subtitles)

            layout.addWidget(QLabel("Yazƒ± Tipi"))
            layout.addWidget(family_combo)
            layout.addWidget(QLabel("Yazƒ± Boyutu"))
            layout.addWidget(size_slider)
            layout.addWidget(bold_check)
            layout.addWidget(italic_check)

            buttons = QDialogButtonBox(QDialogButtonBox.StandardButton.Save | QDialogButtonBox.StandardButton.Cancel)

            def save_and_close():
                self.font_family = family_combo.currentFont().family()
                self.font_size = size_slider.value()
                self.label_bold = bold_check.isChecked()
                self.italic_subtitles = italic_check.isChecked()
                self.apply_font_settings()
                self.statusBar().showMessage("‚úÖ Yazƒ± tipi ayarlarƒ± kaydedildi", 3000)
                self.save_app_state()
                dialog.accept()

            buttons.accepted.connect(save_and_close)
            buttons.rejected.connect(dialog.reject)
            layout.addWidget(buttons)

            dialog.setLayout(layout)
            dialog.exec()
        except Exception as e:
            logger.error(f"Yazƒ± tipi ayarlarƒ± a√ßƒ±lƒ±rken hata: {str(e)}")

    def open_model_management(self):
        try:
            self.model_dialog = QDialog(self)
            dialog = self.model_dialog
            dialog.setWindowTitle("ü§ñ Model Y√∂netimi")
            dialog.setFixedSize(600, 400)

            layout = QVBoxLayout()

            # API Anahtarƒ±
            api_layout = QHBoxLayout()
            api_layout.addWidget(QLabel("üîë OpenRouter API Anahtarƒ±:"))
            self.api_key_edit = QLineEdit()
            self.api_key_edit.setPlaceholderText("sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxx")
            self.api_key_edit.setEchoMode(QLineEdit.EchoMode.Password)
            if self.api_key:
                self.api_key_edit.setText(self.api_key)
            api_layout.addWidget(self.api_key_edit, 1)

            # Anahtarƒ± g√∂ster/gizle
            show_key_btn = QPushButton("üëÅÔ∏è")
            show_key_btn.setCheckable(True)
            show_key_btn.setFixedWidth(30)
            show_key_btn.toggled.connect(lambda checked: self.api_key_edit.setEchoMode(
                QLineEdit.EchoMode.Normal if checked else QLineEdit.EchoMode.Password
            ))
            api_layout.addWidget(show_key_btn)
            layout.addLayout(api_layout)

            # Anahtar almak i√ßin baƒülantƒ±
            key_link = QLabel('<a href="https://openrouter.ai/keys">üîë √úcretsiz API Anahtarƒ± Al</a>')
            key_link.setOpenExternalLinks(True)
            layout.addWidget(key_link)

            # Model Se√ßimi
            model_layout = QHBoxLayout()
            model_layout.addWidget(QLabel("ü§ñ Aktif Model:"))
            self.model_combo_dialog = QComboBox()
            self.model_combo_dialog.addItems(["deepseek-chat", "deepseek-coder", "deepseek-math"])
            self.model_combo_dialog.setCurrentText(self.model_combo.currentText())
            model_layout.addWidget(self.model_combo_dialog, 1)
            layout.addLayout(model_layout)

            # Model Bilgileri
            info_box = QGroupBox("‚ÑπÔ∏è DeepSeek R1 Model Bilgileri")
            info_layout = QVBoxLayout()
            self.model_info = QTextEdit()
            self.model_info.setReadOnly(True)
            self.model_info.setHtml("""
                <b>DeepSeek R1</b>: 128K baƒülam pencereli g√º√ßl√º dil modeli<br>
                <ul>
                    <li><b>Genel Sohbet</b>: Doƒüal diyalog yetenekleri</li>
                    <li><b>Kodlama</b>: √áoklu dil desteƒüi</li>
                    <li><b>Matematik</b>: Mantƒ±ksal akƒ±l y√ºr√ºtme</li>
                </ul>
                <p><b>√úcretsiz Kullanƒ±m:</b></p>
                <ul>
                    <li>Dakikada 5 istek</li>
                    <li>G√ºnl√ºk 100 istek</li>
                    <li>128K baƒülam penceresi</li>
                </ul>
                <b>Dosya Tipi Kƒ±sƒ±tlamalarƒ±:</b>
                <ul>
                    <li>Metin dosyalarƒ± (.txt, .py, .js, .html, etc.)</li>
                    <li>PDF ve Word dok√ºmanlarƒ± (metin i√ßeriƒüi okunur)</li>
                    <li><b>G√∂rsel, ses ve video dosyalarƒ± desteklenmez</b></li>
                </ul>
            """)
            info_layout.addWidget(self.model_info)
            info_box.setLayout(info_layout)
            layout.addWidget(info_box)

            # Butonlar
            button_box = QDialogButtonBox(
                QDialogButtonBox.StandardButton.Save | 
                QDialogButtonBox.StandardButton.Cancel
            )
            button_box.button(QDialogButtonBox.StandardButton.Save).setText("Kaydet")
            button_box.button(QDialogButtonBox.StandardButton.Cancel).setText("ƒ∞ptal")
            button_box.accepted.connect(self.save_model_settings)
            button_box.rejected.connect(dialog.reject)
            layout.addWidget(button_box)

            dialog.setLayout(layout)
            dialog.exec()
        except Exception as e:
            logger.error(f"Model y√∂netimi a√ßƒ±lƒ±rken hata: {str(e)}")
            
    def update_models(self):
        """Modelleri g√ºncelle"""
        try:
            # Ger√ßek g√ºncelleme i≈ülemi i√ßin API entegrasyonu
            self.statusBar().showMessage("üîÑ Modeller g√ºncelleniyor...", 3000)
            QTimer.singleShot(2000, lambda: self.statusBar().showMessage("‚úÖ Modeller g√ºncellendi", 5000))
        except Exception as e:
            logger.error(f"Modeller g√ºncellenirken hata: {str(e)}")

    def save_model_settings(self):
        """Model ve API ayarlarƒ±nƒ± kaydet"""
        try:
            selected_model = self.model_combo_dialog.currentText()
            api_key = self.api_key_edit.text().strip()

            # API anahtarƒ±nƒ± kaydet
            if api_key:
                self.save_api_key(api_key)

            # Ana model se√ßimini g√ºncelle
            self.model_combo.setCurrentText(selected_model)

            self.statusBar().showMessage(f"‚úÖ {selected_model} modeli ayarlandƒ±", 5000)
            self.save_app_state()

            # Diyaloƒüu kapat
            self.model_dialog.accept()
        except Exception as e:
            logger.error(f"Model ayarlarƒ± kaydedilirken hata: {str(e)}")
            
    def show_about(self):
        try:
            about_text = f"""
            <b>DeepSeek Chat</b><br>
            Versiyon: {self.VERSION}<br>
            <br>
            Geli≈ütirici: CxReiS<br>
            <br>
            Bu uygulama PyQt6 ile geli≈ütirilmi≈ütir.<br>
            DeepSeek API entegrasyonu ile √ßalƒ±≈ümaktadƒ±r.<br>
            """
            
            QMessageBox.about(self, "Hakkƒ±nda", about_text)
        except Exception as e:
            logger.error(f"Hakkƒ±nda penceresi a√ßƒ±lƒ±rken hata: {str(e)}")

    def check_for_updates(self):
        try:
            # Burada ger√ßek g√ºncelleme kontrol√º yapƒ±lacak
            QMessageBox.information(self, "G√ºncellemeler", "G√ºncelleme kontrol ediliyor...")
            self.statusBar().showMessage("üîÑ G√ºncellemeler kontrol ediliyor...", 3000)
            QTimer.singleShot(2000, lambda: self.statusBar().showMessage("‚úÖ En g√ºncel s√ºr√ºm kullanƒ±yorsunuz", 5000))
        except Exception as e:
            logger.error(f"G√ºncelleme kontrol edilirken hata: {str(e)}")
    
    def show_chat_context_menu(self, pos):
        try:
            menu = self.chat_display.createStandardContextMenu()
            translations = {
                "&Undo": "Geri Al",
                "&Redo": "ƒ∞leri Al",
                "Cu&t": "Kes",
                "&Copy": "Kopyala",
                "&Paste": "Yapƒ±≈ütƒ±r",
                "Paste and Match Style": "Bi√ßimle E≈üle≈ütirerek Yapƒ±≈ütƒ±r",
                "Delete": "Sil",
                "Select All": "T√ºm√ºn√º Se√ß",
                "Copy Link Location": "Baƒülantƒ± Konumunu Kopyala"
            }
            for action in menu.actions():
                text = action.text().split('\t')[0]
                if text in translations:
                    action.setText(translations[text])
            menu.exec(self.chat_display.mapToGlobal(pos))
        except Exception as e:
            logger.error(f"Baƒülam men√ºs√º g√∂sterilirken hata: {str(e)}")
            
    def show_text_context_menu(self, pos):
        """T√ºrk√ße metin men√ºs√º"""
        try:
            menu = self.message_input.createStandardContextMenu()
            translations = {
                "&Undo": "Geri Al",
                "&Redo": "ƒ∞leri Al",
                "Cu&t": "Kes",
                "&Copy": "Kopyala",
                "&Paste": "Yapƒ±≈ütƒ±r",
                "Paste and Match Style": "Bi√ßimle E≈üle≈ütirerek Yapƒ±≈ütƒ±r",
                "Delete": "Sil",
                "Select All": "T√ºm√ºn√º Se√ß",
                "Copy Link Location": "Baƒülantƒ± Konumunu Kopyala"
            }

            for action in menu.actions():
                text = action.text().split('\t')[0]
                if text in translations:
                    action.setText(translations[text])

            menu.exec(self.message_input.mapToGlobal(pos))
        except Exception as e:
            logger.error(f"Metin men√ºs√º g√∂sterilirken hata: {str(e)}")

    def show_chat_list_context_menu(self, pos):
        """Sohbet listesi i√ßin baƒülam men√ºs√º"""
        try:
            menu = QMenu()

            # Yeniden adlandƒ±r
            rename_action = menu.addAction(QIcon("icons/rename.png"), "Yeniden Adlandƒ±r")
            rename_action.triggered.connect(self.rename_selected_chat)

            # Sil
            delete_action = menu.addAction(QIcon("icons/delete.png"), "Sil")
            delete_action.triggered.connect(self.delete_selected_chat)

            export_action = menu.addAction(QIcon("icons/export.png"), "Sohbeti Dƒ±≈üa Aktar")
            export_action.triggered.connect(self.export_selected_chat)

            menu.exec(self.chat_display.mapToGlobal(pos))
        except Exception as e:
            logger.error(f"Baƒülam men√ºs√º g√∂sterilirken hata: {str(e)}")

    def show_text_context_menu(self, pos):
        """T√ºrk√ße metin men√ºs√º"""
        try:
            menu = self.message_input.createStandardContextMenu()

            self.translate_context_menu(menu)

            menu.exec(self.message_input.mapToGlobal(pos))
        except Exception as e:
            logger.error(f"Metin men√ºs√º g√∂sterilirken hata: {str(e)}")

    def translate_context_menu(self, menu):
        """Baƒülam men√ºs√º eylemlerini T√ºrk√ßeye √ßevir"""
        translations = {
            "&Undo": "Geri Al",
            "&Redo": "ƒ∞leri Al",
            "Cu&t": "Kes",
            "&Copy": "Kopyala",
            "&Paste": "Yapƒ±≈ütƒ±r",
            "Delete": "Sil",
            "Select All": "T√ºm√ºn√º Se√ß",
            "Paste and Match Style": "Bi√ßimle E≈üle≈ütirerek Yapƒ±≈ütƒ±r",
            "Copy Link Location": "Baƒülantƒ± Konumunu Kopyala"
        }
        for action in menu.actions():
            text = action.text().split('\t')[0]
            if text in translations:
                action.setText(translations[text])

    def move_to_main_chat_list(self, item):
        """Sohbeti ana sohbet listesine ta≈üƒ±"""
        chat_title = item.text()
        chat_id = item.data(Qt.ItemDataRole.UserRole)

        new_item = QListWidgetItem(chat_title)
        new_item.setData(Qt.ItemDataRole.UserRole, chat_id)
        new_item.setFlags(new_item.flags() | Qt.ItemFlag.ItemIsEditable)
        self.chat_list.addItem(new_item)

        parent = item.parent()
        if parent:
            parent.removeChild(item)

        self.statusBar().showMessage("üìÇ Sohbet ana listeye ta≈üƒ±ndƒ±", 3000)
        self.save_app_state()

    def project_drag_enter(self, event):
        if event.mimeData().hasFormat('application/x-qabstractitemmodeldatalist'):
            event.acceptProposedAction()

    def project_drop_event(self, event):
        item = self.projects_tree.itemAt(event.position().toPoint())
        if item and not item.parent():
            chat_item = self.chat_list.currentItem()
            if chat_item:
                self.move_chat_to_project(item, chat_item)
                event.acceptProposedAction()
        elif not item:
            chat_item = self.chat_list.currentItem()
            if chat_item:
                self.move_to_main_chat_list(chat_item)
                event.acceptProposedAction()
        else:
            event.ignore()
    
    def rename_selected_chat(self):
        """Se√ßili sohbeti yeniden adlandƒ±r"""
        try:
            if self.chat_list.currentItem():
                self.chat_list.editItem(self.chat_list.currentItem())
            elif self.projects_tree.currentItem() and self.projects_tree.currentItem().parent():
                self.projects_tree.editItem(self.projects_tree.currentItem(), 0)
        except Exception as e:
            logger.error(f"Sohbet yeniden adlandƒ±rƒ±lƒ±rken hata: {str(e)}")

    def delete_selected_chat(self):
        """Se√ßili sohbeti sil"""
        try:
            if self.chat_list.currentItem():
                chat_id = self.chat_list.currentItem().data(Qt.ItemDataRole.UserRole)
                if chat_id in self.chat_data:
                    del self.chat_data[chat_id]
                
                row = self.chat_list.row(self.chat_list.currentItem())
                self.chat_list.takeItem(row)
                self.statusBar().showMessage("üóëÔ∏è Sohbet silindi", 3000)
                self.save_app_state()
                
            elif self.projects_tree.currentItem() and self.projects_tree.currentItem().parent():
                item = self.projects_tree.currentItem()
                chat_id = item.data(0, Qt.ItemDataRole.UserRole)
                if chat_id in self.chat_data:
                    del self.chat_data[chat_id]
                
                parent = item.parent()
                parent.removeChild(item)
                self.statusBar().showMessage("üóëÔ∏è Proje sohbeti silindi", 3000)
                self.save_app_state()
        except Exception as e:
            logger.error(f"Sohbet silinirken hata: {str(e)}")

    def load_project_context(self, current, previous):
        if current and not current.parent():
            pid = id(current)
            if pid not in self.project_context:
                self.project_context[pid] = {"instructions": "", "files": []}
            ctx = self.project_context[pid]
            self.project_instructions.setText(ctx["instructions"])
            self.project_files_list.clear()
            for f in ctx["files"]:
                self.project_files_list.addItem(f)

    def add_project_file(self):
        current = self.projects_tree.currentItem()
        if current and not current.parent():
            file_path, _ = QFileDialog.getOpenFileName(self, "Dosya Se√ß", "", "T√ºm Dosyalar (*)")
            if file_path:
                pid = id(current)
                if pid not in self.project_context:
                    self.project_context[pid] = {"instructions": "", "files": []}
                self.project_context[pid]["files"].append(file_path)
                self.project_files_list.addItem(file_path)
                self.save_project_context()

    def remove_project_file(self):
        current = self.projects_tree.currentItem()
        item = self.project_files_list.currentItem()
        if current and not current.parent() and item:
            pid = id(current)
            file_path = item.text()
            self.project_files_list.takeItem(self.project_files_list.row(item))
            if pid in self.project_context and file_path in self.project_context[pid]["files"]:
                self.project_context[pid]["files"].remove(file_path)
                self.save_project_context()

    def save_project_context(self):
        current = self.projects_tree.currentItem()
        if current and not current.parent():
            pid = id(current)
            self.project_context[pid] = {
                "instructions": self.project_instructions.toPlainText(),
                "files": [self.project_files_list.item(i).text() for i in range(self.project_files_list.count())]
            }
    
    def save_app_state(self):
        """Uygulama durumunu kaydet"""
        try:
            self.save_project_context()
            # Chat listesini kaydet
            chat_items = []
            for i in range(self.chat_list.count()):
                item = self.chat_list.item(i)
                chat_items.append({
                    "title": item.text(),
                    "id": item.data(Qt.ItemDataRole.UserRole)
                })
            
            # Proje aƒüacƒ±nƒ± kaydet
            def save_tree_item(item):
                data = {
                    "text": item.text(0),
                    "id": item.data(0, Qt.ItemDataRole.UserRole),
                    "children": []
                }
                for i in range(item.childCount()):
                    child = item.child(i)
                    data["children"].append(save_tree_item(child))
                return data
            
            projects = []
            for i in range(self.projects_tree.topLevelItemCount()):
                item = self.projects_tree.topLevelItem(i)
                projects.append(save_tree_item(item))
            
            app_state = {
                "version": self.VERSION,
                "chats": chat_items,
                "projects": projects,
                "chat_data": self.chat_data,
                "model": self.model_combo.currentText(),
                "theme": self.current_theme,
                "font_family": self.font_family,
                "font_size": self.font_size,
                "label_bold": self.label_bold,
                "italic_subtitles": self.italic_subtitles,
                "project_context": self.project_context,
                "shortcuts": {
                    "send": self.send_action.shortcut().toString(),
                    "newline": self.newline_action.shortcut().toString(),
                    "fullscreen": self.fullscreen_action.shortcut().toString(),
                    "minimize": self.minimize_action.shortcut().toString()
                },
                "active_chat_id": self.active_chat_id
            }
            
            with open("app_state.json", "w") as f:
                json.dump(app_state, f, indent=2)
                
            logger.info("Uygulama durumu kaydedildi")
        except Exception as e:
            logger.error(f"Uygulama durumu kaydedilirken hata: {str(e)}")

    def load_app_state(self):
        """Uygulama durumunu y√ºkle"""
        try:
            self.chat_data = {}
            if os.path.exists("app_state.json"):
                with open("app_state.json", "r") as f:
                    app_state = json.load(f)
                    
                    # Chat listesini y√ºkle
                    self.chat_list.clear()
                    for chat in app_state.get("chats", []):
                        item = QListWidgetItem(chat["title"])
                        item.setData(Qt.ItemDataRole.UserRole, chat["id"])
                        item.setFlags(item.flags() | Qt.ItemFlag.ItemIsEditable)
                        self.chat_list.addItem(item)
                        
                        # Chat verilerini y√ºkle
                        if "chat_data" in app_state and chat["id"] in app_state["chat_data"]:
                            self.chat_data[chat["id"]] = app_state["chat_data"][chat["id"]]
                    
                    # Proje aƒüacƒ±nƒ± y√ºkle
                    self.projects_tree.clear()
                    for project in app_state.get("projects", []):
                        def load_tree_item(data, parent=None):
                            item = QTreeWidgetItem([data["text"]])
                            if data["id"]:
                                item.setData(0, Qt.ItemDataRole.UserRole, data["id"])
                            
                            # Chat verilerini y√ºkle
                            if "chat_data" in app_state and data["id"] in app_state["chat_data"]:
                                self.chat_data[data["id"]] = app_state["chat_data"][data["id"]]
                            
                            for child_data in data["children"]:
                                child_item = load_tree_item(child_data)
                                item.addChild(child_item)
                            return item
                        
                        item = load_tree_item(project)
                        self.projects_tree.addTopLevelItem(item)
                    
                    # Modeli y√ºkle
                    model = app_state.get("model", "deepseek-chat")
                    self.model_combo.setCurrentText(model)
                    
                    # Temayƒ± y√ºkle
                    theme = app_state.get("theme", "dark")
                    self.apply_theme(theme)
                    self.current_theme = theme

                    self.font_family = app_state.get("font_family", "Arial")
                    self.font_size = app_state.get("font_size", 16)
                    self.label_bold = app_state.get("label_bold", True)
                    self.italic_subtitles = app_state.get("italic_subtitles", False)
                    self.apply_font_settings()
                    self.project_context = app_state.get("project_context", {})

                    # Kƒ±sayollarƒ± y√ºkle
                    shortcuts = app_state.get("shortcuts", {})
                    self.send_action.setShortcut(QKeySequence(shortcuts.get("send", "Ctrl+Return")))
                    self.newline_action.setShortcut(QKeySequence(shortcuts.get("newline", "Return")))
                    self.fullscreen_action.setShortcut(QKeySequence(shortcuts.get("fullscreen", "F11")))
                    self.minimize_action.setShortcut(QKeySequence(shortcuts.get("minimize", "Ctrl+M")))
                    
                    # Aktif sohbeti y√ºkle
                    self.active_chat_id = app_state.get("active_chat_id")
                    if self.active_chat_id and self.active_chat_id in self.chat_data:
                        # Aktif sohbeti bul ve y√ºkle
                        found = False
                        
                        # Chat listesinde ara
                        for i in range(self.chat_list.count()):
                            item = self.chat_list.item(i)
                            if item.data(Qt.ItemDataRole.UserRole) == self.active_chat_id:
                                self.chat_list.setCurrentItem(item)
                                self.load_chat(item)
                                found = True
                                break
                        
                        # Proje sohbetlerinde ara
                        if not found:
                            def find_chat_in_tree(item):
                                if item.data(0, Qt.ItemDataRole.UserRole) == self.active_chat_id:
                                    self.projects_tree.setCurrentItem(item)
                                    self.load_project_chat(item, 0)
                                    return True
                                for i in range(item.childCount()):
                                    if find_chat_in_tree(item.child(i)):
                                        return True
                                return False
                            
                            for i in range(self.projects_tree.topLevelItemCount()):
                                if find_chat_in_tree(self.projects_tree.topLevelItem(i)):
                                    break
                    
                logger.info("Uygulama durumu y√ºklendi")
        except Exception as e:
            logger.error(f"Uygulama durumu y√ºklenirken hata: {str(e)}")
            # Hata durumunda temiz ba≈ülangƒ±√ß
            self.chat_data = {}
    
    def show_and_activate(self):
        """Pencereyi g√∂ster ve √∂ne getir"""
        self.show()
        self.activateWindow()
        self.raise_()
    
    def quit_application(self):
        """Uygulamadan tamamen √ßƒ±k"""
        self.tray_icon.hide()
        self.save_app_state()
        QApplication.quit()    

    def closeEvent(self, event):
        """Pencere kapatma olayƒ±"""
        try:
            event.ignore()
            self.minimize_to_tray()
            self.save_app_state()
        except Exception as e:
            logger.error(f"Uygulama kapatƒ±lƒ±rken hata: {str(e)}")

if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setApplicationName("DeepSeek Chat")
    
    # Font ayarƒ±
    font = app.font()
    font.setPointSize(10)
    app.setFont(font)
    
    try:
        # Giri≈ü bilgilerini kontrol et
        if os.path.exists("user_prefs.json"):
            with open("user_prefs.json", "r") as f:
                prefs = json.load(f)
                if prefs.get("remember", False):
                    window = MainApplication()
                    window.show()
                    sys.exit(app.exec())
        
        # Normal giri≈ü ekranƒ± i√ßin
        login_window = LoginWindow()
        login_window.show()
        sys.exit(app.exec())
    except Exception as e:
        logger.error(f"Uygulama ba≈ülatƒ±lƒ±rken hata: {str(e)}")
        error_dialog = ErrorDialog(str(e))
        error_dialog.exec()
        sys.exit(1)
